---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# <img src="https://i.imgur.com/vTLlhbp.png" align="right" height=88 /> Compute biomass fluxes at ForestGEO sites

[![lifecycle](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://www.tidyverse.org/lifecycle/#experimental)
[![Travis build status](https://travis-ci.org/forestgeo/AGBfluxes.svg?branch=master)](https://travis-ci.org/forestgeo/AGBfluxes)
[![CRAN status](https://www.r-pkg.org/badges/version/AGBfluxes)](https://cran.r-project.org/package=AGBfluxes)
 [![Coverage status](https://coveralls.io/repos/github/forestgeo/AGBfluxes/badge.svg)](https://coveralls.io/r/forestgeo/AGBfluxes?branch=master)

## Installation

You can install the released version of AGBfluxes from [CRAN](https://CRAN.R-project.org) with:

``` r
# install.packages("devtools")
devtools::install_github("AGBfluxes")
```

## Example

`data_preparation()` outputs a data.table, which has a special `print()` method.

```{r, error=TRUE}
library(AGBfluxes)

# Make sure the name of your site is as in the database.
# FIXME: We can be more flexible here. And try match insensitive to case
sited <- site.info$site
mysite <- as.character(sited[grep("Barro", sited, ignore.case = TRUE)])
mysite

prep <- data_preparation(site = mysite, stem = TRUE)

head(prep)
```

The output is of class "data.table".

```{r}
class(prep)
```

You can save the output to a csv file of your choice.

```{r}
temp_file <- tempfile()
write.csv(prep, temp_file)
```

Then read it and re-use it as needed.

```{r}
prep_2 <- read.csv(temp_file, stringsAsFactors = FALSE)
prep_2[1:5, 1:5]
```

The newly read object is no longer of class "data.table". 

(TODO: We should probably output a simple "data.frame" from `data_preparation()`. The output is small and I see no benefit on producing a "data.table".)

### Side effects

TODO: a funciton should either compute something or throw side effects, not both. We should likely exctact out the functionality that produces side effects.

Currently `data_preparation()` can produce two side effects:

* Write a .csv file with error flags.
* Write .pdf file(s) showing problematic trees.

```{r warning=FALSE}
tmp <- tempdir()

errors <- paste0(tmp, "/errors")
# You would do something like this: 
# errors <- "results/errors"

problems <- paste0(tmp, "/problems")
# You would do somethign like this: 
# problems <- "results/problems"

prep_3 <- data_preparation(
  site = "barro colorado island",
  stem = TRUE,
  write_errors_to = errors,
  graph_problems_to = problems
)
```

Show that side effects have been saved.

```{r}
dir(tmp, pattern = "csv$|pdf$$")
```

```{r}
prep_3 <- read.csv(paste0(tmp, "/errors.csv"))
names(prep_3)
dim(prep_3)
```

